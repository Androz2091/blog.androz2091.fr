---
title: Cloner sa carte de cantine
date: 2022-06-09
image: ./nfc-banner.png
imageAlt: Technologie NFC utilis√©e dans les cartes
---

La technologie NFC (Near Field Communication) est omnipr√©sente dans notre quotidien. Payer par carte bleue sans contact (ou via son smartphone), valider un ticket de m√©tro, biper sa carte de cantine... tout cela est possible gr√¢ce au NFC.

Si vous souhaitez en apprendre plus sur cette technologie (ou suivre mes gal√®res dans mon exp√©rience :), vous √™tes au bon endroit !

Est-il possible de dupliquer sa carte de cantine pour en faire un double ? Et si oui, comment ? C'est ce que je me suis demand√© il y a 6 mois maintenant üòÑ

Pour commencer, je r√©cup√®re quelques informations sur ma carte sur mon t√©l√©phone avec l'application `NFC Tools`.

## Essai #1 : via un smartphone Android

![nfc-tools](./nfc-tools.jpg)

Je d√©couvre alors qu'il s'agit d'une carte NFC produite par la soci√©t√© Mifare. Le mod√®le exact de la carte est Mifare Classic 1k.

Apr√®s quelques recherches, je tombe sur [cet article](https://www.latelierdugeek.fr/tag/mifare-classic/), qui explique comment dupliquer un badge d'immeuble Mifare directement avec son smartphone Android et l'application [Mifare Classic Tool](https://play.google.com/store/apps/details?id=de.syss.MifareClassicTool).

Pour cela, il faut donc passer par trois √©tapes :
* acheter une carte NFC vierge
* lire les donn√©es de la carte de cantine
* les √©crire sur la nouvelle carte NFC vierge

Or... m√™me en suivant exactement les √©tapes list√©es dans l'article ci-dessus, l'appli ne fonctionne pas avec ma carte. et voil√† pourquoi ci-dessous :)

## Carte NFC Mifare Classic 1k 

Une carte NFC Mifare, c'est une puce qui stocke des chiffres (au format hexad√©cimal).

* Chaque **carte** dispose de 752 octets de stockage r√©partis sur **16 secteurs** num√©rot√©s de 0 √† 15.
* Chaque **secteur** dispose de **3 blocks** (de 16 octets) num√©rot√©s de 0 √† 2 pour stocker des donn√©es.

![content-mifare-card](./content-card-mifare.png)
> Exemple de contenu de carte NFC Mifare Classic 1k (d√©chiffr√©e car les clefs A et B de chaque secteur sont visibles)

### Blocks d'authentification

Seulement, comme vous pouvez le voir sur la capture d'√©cran, chaque secteur dispose en r√©alit√© d'un **4√®me block**, qui sert √† prot√©ger les donn√©es du secteur. Celui-ci stocke **une clef A** et **une clef B**, auxquelles nous n'avons pas acc√®s facilement. Et sans celles-ci, impossible d'acc√©der aux 3 autres blocks.

Or, [en 2008, a √©t√© d√©couverte une faille](https://fr.wikipedia.org/wiki/Mifare#S%C3%A9curit%C3%A9) pour tenter trouver les clefs d'une carte Mifare sans √™tre un lecteur approuv√©. C'est ce que tente de faire Mifare Classic Tool.

![classic-tools](./classic-tools.jpg)

Cependant, comme vous pouvez le voir ici, seule la clef A est trouv√©e par l'application mobile (et m√™me aucune sur le secteur 1). Apr√®s plusieurs essais, il faut s'y r√©soudre, cette simple application ne suffiera pas pour hacker les clefs ma carte de cantine... !

### Block UID verrouill√©

Apr√®s ce premier probl√®me de blocks d'authentification, nous en avons un second.

Vous avez peut-√™tre remarqu√© que 16 secteurs \* 3 blocks de stockage \* 16 octets = 768... et non 752 ? En effet, **le block 0 du secteur 0** est utilis√© pour stocker **l'identifiant unique de la carte**. Celui-ci est **verrouill√©** et ne peut pas √™tre modifi√© une fois hors de l'usine.

C'est donc un autre probl√®me. Si on veut cr√©er un clone parfait, il va nous falloir une carte Mifare Classic 1k sp√©ciale, avec un UID modifiable.

## Essai #2 : lecteur NFC et cartes chinoises

Voici ce qui m'a permis de parvenir √† r√©soudre ces probl√®mes.

### Lecture de la carte via bruteforce

Si la carte ne peut pas √™tre hack√©e via un smartphone, il va nous falloir lire les donn√©es avec un autre appareil, comme un ordinateur.

En effet, nous pourrons alors faire tourner LibNFC, un logiciel qui permet de faire des millions de tentatives jusqu'√† trouver les bonnes clefs de la carte (attaque bruteforce).

Pour cela, il m'a fallu acheter un [lecteur NFC ACR122U](https://boutique.latelierdugeek.fr/produit/rfid-nfc-lecteur-rfid-nfc-acr122u-compatible-libnfc/) :

![lecteur](./lecteur.jpg)

Maintenant... il nous faut un ordinateur capable d'ex√©cuter LibNFC. Je ne disposais que d'un ordi portable peu puissant sous Windows et d'un Mac M1. Je tente d'abord d'utiliser LibNFC sur mon Mac. Or, j'obtiens en boucle cette erreur lors de l'ex√©cution :

![m1](./mac-m1.png)

En fait, macOS tente de lire le lecteur NFC comme un p√©riph√©rique USB, ce qui a pour cons√©quence de bloquer l'acc√®s en lecture au lecteur √† LibNFC. Pour d√©sactiver ce comportement de l'OS, il faut modifier un fichier de configuration... pr√©sent sur un disque en readonly depuis la derni√®re mise √† jour macOS. Autant oublier de suite.

S'ensuit une s√©rie de tentatives toutes plus alambiqu√©es les unes que les autres pour lire la carte sur un ordinateur. Dual-boot du portable pour le lancer sous Linux, utilisation d'USB over network, de machines virtuelles,... aucune solution ne fonctionne vraiment, soit par manque de performance, soit par incompatibilit√©.

Mais 6 mois plus tard, je d√©cide d'acheter un portable, et de prendre un laptop sous Linux. Le projet peut reprendre!

J'installe LibNFC sans probl√®me, ainsi que `mfoc`, qui permet de lancer le processus de bruteforce. Et l√†...

![mfoc](./mfoc-error.png)

Un joli Card is not vulnerable to nested attack s'affiche üôÇ

Au moins, on comprend pourquoi Mifare Classic Tool ne fonctionnait pas, la carte n'est pas vuln√©rable √† l'attaque "nested" (celle utilis√©e par l'appli mobile). Heureusement, il existe √©galement une attaque "hardnested". Celle-ci est beaucoup plus lourde, mais pourrait parvenir √† trouver les clefs.

![mfoc-hardnested](./mfoc-hardnested.png)

La nuit passe... et pendant ce temps `mfoc-hardnested` craque un par un les 16 secteurs de la carte. Et le lendemain matin... tout est termin√© ! üéâ

La carte est enti√®rement lue et les clefs A et B de chaque secteur sont disponibles ! Nous pouvons maintenant proc√©der √† l'√©tape 2, l'√©criture sur la fausse carte.

### Ecriture de la carte sur une copie chinoise

Maintenant se pose encore un probl√®me, l'UID qui ne peut pas √™tre modifi√© sur une carte Mifare standard. Pour cela, nous pouvons passer par des copies chinoises. En effet, celles-ci sont con√ßues pour fonctionner exactement comme une carte Mifare Classic 1k, en autorisant cependant l'√©criture du block 0 du secteur 0 !

Des copies de Mifare de bonnes qualit√©s sont disponibles sur le site de [L'atelier du geek](https://boutique.latelierdugeek.fr/).

![L'atelier du geek](./latelierdugeek.png)

Il faut d'abord lire la carte chinoise pour r√©cup√©rer les clefs A et B qui me permettront de modifier ses blocs. Un simple `mfoc -O carte-vierge.mfd` suffit, car les clefs par d√©faut de la carte chinoise sont toutes √©gales √† `ffffffffffff` par d√©faut.

Pour √©crire sur la carte chinoise, j'essaie d'abord d'utiliser la commande `nfc-mfclassic`, avec les options basiques, `W` pour √©crire les 16 secteurs, et `a` pour afficher les erreurs s'il y en a.

![nfc-mfclassic](./nfc-mfclassic-1.png)

Aucune erreur, tout semble parfaitement fonctionner... mais en lisant de nouveau la carte chinoise, les donn√©es ne sont pas les bonnes (les donn√©es ne sont pas √©gales √† la carte originale). ü•≤

Apr√®s une longue soir√©e √† passer √† debugger et √† chercher, je d√©couvre enfin o√π est le probl√®me. La commande qui fonctionne est en fait `nfc-mfclassic W a u carte-cantine-originale.mfd carte-vierge.mfd f`.

L'utilisation du param√®tre `f` permet de confirmer l'√©criture sur la carte chinoise de donn√©es contenant un UID diff√©rent (forc√©ment, la copie chinoise ne disposait pas du bon UID avant l'√©criture).
L'utilisation du param√®tre `u` permet de confirmer que nfc-mfclassic doit utiliser l'UID de la carte de cantine originale.

Et voil√† !

Dans la journ√©e, un test avec la copie chinoise suffit √† me confirmer que tout fonctionne correctement, le tourniquet de la cantine n'y voit que du feu üî•

## Merci <3

M√™me si j'ai d'abord commenc√© ce projet seul, je tiens √† remercier √©norm√©ment Romain, qui a pass√© de longues heures √† m'aider pour trouver des solutions aux diff√©rents probl√®mes que j'ai pu rencontrer !

Merci √©galement √† la communaut√© [Techcord](https://discord.com/invite/YaM7BwX) qui m'a aid√© √† choisir un bon ordi (et m'aide toujours au quotidien :).

Et enfin, un grand merci √† vous d'√™tre rest√© jusqu'au bout de cet article. Ce sont des notions un peu complexes et m√™me si j'ai fait de mon mieux pour tout condenser et expliquer clairement, je me doute que ce n'est pas l'article le plus simple √† comprendre de ce blog! N'h√©sitez pas √† m'envoyer vos questions [sur Twitter](https://twitter.com/androz2091).

*Cet article se concentre principalement sur mon exp√©rience avec les cartes Mifare et les difficult√©s que j'ai pu rencontrer personnellement. Si vous souhaitez aller plus loin et en apprendre plus sur le fonctionnement g√©n√©ral de la RFID, je vous conseille [ce tr√®s bon article](https://sbedirect.com/fr/blog/article/comprendre-la-rfid-en-10-points.html).* 
