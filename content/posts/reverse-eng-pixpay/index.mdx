---
title: Reverse engineering de PixPay
date: 2021-03-13
image: ./pixpay.png
imageAlt: Logo de PixPay.fr
---

Bonjour √† tous. Dans ce premier post sur ce blog, je vais d√©tailler l'ing√©nierie invers√©e (reverse engineering) de l'application PixPay, une n√©o-banque fran√ßaise.

Cet article me sert √† la fois de notes dans le cas o√π j'aurais √† faire de nouveau cela avec une autre application, et √† la fois de tutoriel pour que vous puissiez (peut-√™tre) apprendre quelques petites choses !

Dans ce post, j'utiliserai [Charles Proxy](https://charlesproxy.com), [ProxyDroid](https://play.google.com/store/apps/details?id=org.proxydroid), un Android 7.0 root√© (en fait un Samsung J3 2016 Android 5.0 avec une ROM Android 7.0) et [Frida](https://frida.re). 

## Reverse engineequoi ?

L'ing√©nierie invers√©e (reverse engineering en anglais) consiste √† √©tudier la fa√ßon dont a √©t√© con√ßue une application, souvent pour pouvoir automatiser certaines actions de l'application avec du code. Un petit exemple parlant, si on comprend comment fonctionne Instagram, on peut parvenir √† publier automatiquement des posts avec un script.

## Pourquoi avoir choisi PixPay ?

Apr√®s avoir d√©j√† fait un peu d'ing√©nierie invers√©e avec l'application Pronote, je voulais me familiariser un peu avec Charles Proxy et tous ces outils. Intercepter les requ√™tes de l'application n'aurait du me prendre qu'une petite heure mais comme vous allez le voir, cela s'est av√©r√© un peu plus ardu. J'ai choisi PixPay par curiosit√© pour ces "n√©o-banques" et parce que c'est une des seules qui n'a pas d√©j√† √©t√© √©tudi√©e.

## Intercepter les requ√™tes

Bon, maintenant que j'ai choisi l'application, PixPay, il faut trouver un moyen de comprendre comment elle fonctionne, et plus exactement comment fonctionne son API priv√©e. Par exemple, pour s'inscrire il faut peut-√™tre envoyer une requ√™te √† `https://api.pixpay.fr/auth/register` avec comme param√®tre un num√©ro de t√©l√©phone et un mot de passe. Le probl√®me, c'est que je ne peux pas tester toutes les requ√™tes imaginables (`/auth/register`, `/register`, `/appregister`...) en testant avec diff√©rents noms dans les formulaires. Ce serait beaucoup trop long et n'aurait que peu de chance de succ√®s.

Pour cela, le plus simple est donc de lancer l'application sur son t√©l√©phone et de connecter son t√©l√©phone √† un **serveur proxy** (ici mon ordinateur), qui va intercepter toutes les requ√™tes partant du t√©l√©phone. Voil√† un petit sch√©ma :

![proxy](./proxy.png)

Comme toutes les requ√™tes entre l'application et l'API sont intercept√©es, cela va me permettre de trouver toutes les URLs (`endpoints`) de l'API en naviguant simplement sur l'application.

## Lan√ßons Charles Proxy

Pour cela, j'ai d√©cid√© d'utiliser Charles Proxy, un logiciel qui nous permet de lancer un serveur proxy sur un ordinateur pour m'y connecter avec mon t√©l√©phone. Il y a de nombreux tutoriels sur Google, mais en r√©sum√© :
* t√©l√©chargez Charles sur https://www.charlesproxy.com/ (de nombreux cracks existent, sinon $20 √† vie)
* lancez Charles
* dans les param√®tres Wifi de votre t√©l√©phone, configurer un proxy avec comme `host` l'adresse IP locale de votre ordinateur et comme pot `8888`
* dans les param√®tres de Charles > SSL Proxying, ajoutez un domaine `*`.
* ouvrez un navigateur et tapez `https://chls.pro/ssl` pour t√©l√©charger le certificat SSL de Charles puis installez-le sur votre t√©l√©phone (en cliquant sur le fichier t√©l√©charg√©)

Une fois Charles et votre t√©l√©phone configur√©s, vous pouvez essayer de faire une recherche Google, vous verrez que celle-ci apparaitra dans Charles.

![charles](./charles-google.png)

## Flutter, le framework Android... qui ne suit pas les param√®tres Android

Voil√†, maintenant je devrais pouvoir lancer PixPay et voir les requ√™tes ! Sauf que... non. Je lance PixPay et **aucune** requ√™te √† l'API ne s'affiche. Pas d'erreur, rien n'est juste affich√© dans Charles. La r√©ponse, que j'ai fini par trouver apr√®s un moment : PixPay utilise **[Flutter](http://flutter.dev/)**, un framework de d√©veloppement pour applications Android (que j'ai d'ailleurs utilis√© pour mon appli [Notifications pour Pronote](https://github.com/pronote-notifications/pronote-notifications-app)). Et ce framework n'utilise pas le proxy configur√© dans les param√®tres Wifi du t√©l√©phone. G√©nial.

## Forcer l'utilisation de notre proxy

Pour pallier ce probl√®me, j'ai utilis√© ProxyDroid. C'est une application qui vous permet de forcer l'utilisation d'un proxy sur le t√©l√©phone. √âvidemment, cette appli a besoin du root pour fonctionner. Une semaine plus tard, je r√©cup√®re un vieux Samsung S4 Mini (Android 4) que j'avais root√©. J'essaye de faire l'installation avec ADB et... √ßa ne fonctionne pas. L'application n√©cessite Android 5 pour fonctionner. Je r√©cup√®re donc un vieux Samsung J3 2016. Il ne reste plus qu'√† le rooter... Je vous passe les d√©tails mais apr√®s quelques heures pass√©es en vocal avec [@kaki87](https://github.com/kaki87), que je re-remercie infiniment, mon J3 est root√© avec Magisk et XPosed (et une ROM custom, resurrection remix, sous Android 7).

## SSL handshake failed.

Bon, on relance PixPay maintenant. Et √ßa ne fonctionne toujours pas. "SSL handshake failed" dans Charles.

![ssl handshake](./pixpay-failed.png)

### Certificat syst√®me 

J'ai d'abord essay√© de d√©placer le certificat de Charles des certificats utilisateurs vers les certificats syst√®mes mais Flutter... ne fait m√™me pas confiance aux certificats syst√®mes. üôÇ

### SSL Pinning

En r√©sum√©, l'application utilise une protection de type SSL Pinning. Pour les curieux, [Micode](https://www.youtube.com/watch?v=AzhnqtQKKHM) explique tr√®s bien ce que c'est dans sa vid√©o. Pour contourner cette protection nous avons 3 solutions :
* "d√©compiler" l'APK pour extraire les fichiers smali et trouver le pin SSL pour le remplacer par celui de Charles
* utiliser un module XPosed comme [JustTrustMe](https://github.com/Fuzion24/JustTrustMe) ou [TrustMeAlready](https://github.com/ViRb3/TrustMeAlready)
* utiliser [Frida](https://frida.re/)

Apr√®s avoir essay√© 4-5 plugins Magisk il faut se rendre √† l'√©vidence, ces plugins Magisk "universels" ne fonctionneront pas avec PixPay. J'ai aussi essay√© de d√©compiler l'APK, mais impossible de trouver de pin SSL (m√™me si c'est peut-√™tre possible).

Je tombe alors sur [un tr√®s bon article](https://blog.nviso.eu/2019/08/13/intercepting-traffic-from-android-flutter-applications/) qui utilise Frida. Pour installer Frida :
* si vous poss√©dez Magisk, il existe [MagiskFrida](https://github.com/AeonLucid/MagiskFrida) qui vous fait l'installation automatiquement
* sinon, suivez [ce tuto](https://frida.re/docs/android/)

Je cr√©√© le fichier `frida.js`:
```js
function hook_ssl_verify_result(address){
  Interceptor.attach(address, {
    onEnter: function(args) {
      console.log("Disabling SSL validation")
    },
    onLeave: function(retval) {
      console.log("Retval: " + retval)
      retval.replace(0x1);
    }
  })
}

function disablePinning(){
  const m = Process.findModuleByName("libflutter.so")
  const pattern = "2d e9 f0 4f a3 b0 82 46 50 20 10 70"
  const res = Memory.scan(m.base, m.size, pattern, {
    onMatch: function(address, size){
      console.log('[+] ssl_verify_result found at: ' + address.toString())
      hook_ssl_verify_result(address.add(0x01))
    }, 
    onError: function(reason){
      console.log('[!] There was an error scanning memory')
    },
    onComplete: function(){
        console.log("All done")
    }
  })
}

setTimeout(disablePinning, 1000)
```

Ce script est tr√®s int√©ressant, je vous invite √† lire [ceci](https://blog.nviso.eu/2019/08/13/intercepting-traffic-from-android-flutter-applications/) pour comprendre comment il fonctionne.
Je lance alors `frida -U -f fr.pixpay -l frida.js --no-pause`, puis lance PixPay et l√†... 

![pixpay](./charles-pixpay.png)

√áa fonctionne. J'ai maintenant acc√®s √† l'int√©gralit√© des requ√™tes qui partent de PixPay vers son API !

Nous avons donc une premi√®re requ√™te pour la connexion vers `https://prod-auth.pixpay.app/auth/login`. Cette requ√™te, si elle r√©ussit, nous renvoie un `token`. 
Toutes les autres requ√™tes fonctionnent avec GraphQL et l'endpoint `https://prod-bo1.pixpay.app/graphql`, authentifi√©es avec le `token` r√©cup√©r√© pr√©c√©demment.

## Cr√©er une librairie JavaScript

Il ne me reste plus qu'√† cr√©er un compte, mettre quelques euros dessus et cr√©er une petite lib JS pour le fun en impl√©mentant les endpoints principaux.
La librairie finale est disponible sur **[GitHub](https://github.com/Androz2091/pixpay-api)**!

Merci d'avoir lu jusqu'ici et j'esp√®re que ce post aura pu vous en apprendre un peu plus sur l'ing√©nierie invers√©e, des applications Flutter notamment! Je remercie encore une fois [Kaki87](https://github.com/kaki87) qui m'a beaucoup aid√© ainsi que l'auteur du script Frida, [Jeroen Beckers](https://blog.nviso.eu/author/dauntless/).
