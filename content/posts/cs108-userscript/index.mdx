---
title: (CS-108) Un userscript pour am√©liorer la lisibilit√© des consignes
date: 2024-03-01
image: ./violentmonkey.png
imageAlt: ViolentMonkey
---

Hello, nouveau tutoriel pour le cours CS-108 de Michel Schinz.

L'objectif ici est d'am√©liorer un peu la lisibilit√© des consignes en r√©glant deux probl√®mes :
* les conseils de programmation sont toujours **apr√®s** la d√©finition de la m√©thode
* souvent, le nom des m√©thode √† cr√©er n'est pas assez mis en avant √† mon go√ªt
* on ne peut pas copier les liens des sections pour les r√©f√©rencer ailleurs (sur ED par exemple)

Pour cela, nous allons devoir modifier le style de la page dynamiquement avec un userscript (un script JavaScript √©crit par un utilisateur pour modifier le comportement d'un site).

![result](./result.png)

> Le r√©sultat final nous permettra de mettre en avant les m√©thodes, et d'ajouter un lien pour jumper aux conseils **sp√©cifique √† chaque m√©thode** sans attendre

Il existe des dizaines d'extensions permettant de mettre en place ces `userscripts`. Nous allons ici utiliser `ViolentMonkey`, open source et bien maintenu.

**[TL;DR le lien du script final](./script.js)** (√† importer dans ViolentMonkey)

## D√©tection des d√©finitions de m√©thodes

Dans un premier temps, il nous faut d√©tecter les m√©thodes pr√©sentes dans la consigne. Cela peut se faire √† l'aide de l'instruction suivante :

```js
const methods = new Set();

const listItems = document.querySelectorAll('li');
for (listItem of listItems) {

    const firstCode = listItem.querySelector('code:first-of-type');
    if (firstCode) {
        firstCode.style.backgroundColor = '#808080';
        firstCode.style.color = 'white';

        console.log('[METHODE] d√©finition de m√©thode trouv√©e, ' + firstCode.innerText);
        methods.add(firstCode);
    }
}
```

Pour cela, on a donc pris le premier √©l√©ment formatt√© comme du code dans chaque liste. Nous appliquons un background gris et modifions la couleur du texte.

Nous stockons √©galement la m√©thode dans un `Set`, qui nous servira plus tard.

## D√©tection des conseils de programmation

Dans un second temps, nous voulons d√©tecter les conseils de programmation. Nous pouvons utiliser notre code pr√©c√©dent v√©rifiant si le titre de la section est "Conseils de programmation".

```js
const listItems = document.querySelectorAll('li');
for (listItem of listItems) {
    // are we in a conseils de programmation ? :)
    const parentDiv = listItem.parentNode.parentNode;
    const isConseilsDeProg = parentDiv.id.includes('outline-container') && parentDiv.children[0].innerHTML.includes('Conseils de programmation');
    if (isConseilsDeProg) conseilsDeProg.add(parentDiv);
}
```

## Lier les deux

Enfin, nous pouvons lier les deux en utilisant ce bout de code qui fait le matching entre une m√©thode et un conseil, et qui cr√©√© une balise de lien `<a>` pour jumper vers le bon conseil.

```js
conseilsDeProg.forEach((parentDiv) => {

  const titles = parentDiv.querySelectorAll('li > code:first-of-type');
  for (title of titles) {
    console.log('[CONSEIL] conseil trouv√© pour la m√©thode ' + title.innerText);
    const id = title.parentNode.children[0].id;

    for (method of methods) {
      if (method.innerText.includes(title.innerText)) {
        console.log('[MATCHING] conseil pour ' + title.innerText + ' matched');
        const a = document.createElement('a');
        a.innerHTML = '<b> (voir les conseils de programmation) </b>';
        a.href = '#' + id;
        method.parentNode.appendChild(a);
      }
    }
  }

});
```

Finalement, on boucle sur tous les titres pour leur ajouter un lien de r√©f√©rence :

```js
for (header of document.querySelectorAll('h3, h4, h5, h6')) {
  console.log(header.id);
  const a = document.createElement('a');
  a.href = 'javascript:void(0)';
  a.innerText = '(üìã)';
  a.style.marginLeft = '5px';
  header.appendChild(a);
  const link = `${window.location.origin}${window.location.pathname}#${header.id}`;
  a.onclick = () => {
    a.innerText = '(‚úÖ link copied)';
    setTimeout(() => a.innerText = '(üìã)', 1_000);
    navigator.clipboard.writeText(link).then(function() {
      console.log('Async: Copying to clipboard was successful!');
    }, function(err) {
      console.error('Async: Could not copy text: ', err);
    });
  }
}
```
